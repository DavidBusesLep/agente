<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Orchestrator - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-gray-50 text-gray-900">
    <div class="max-w-4xl mx-auto py-10 px-4">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">Dashboard</h1>
        <button id="logout" class="text-sm text-red-600">Cerrar sesión</button>
      </div>
      <div id="info" class="grid md:grid-cols-3 gap-4 mb-8"></div>

      <!-- Configuración de IA por tenant -->
      <div class="bg-white rounded shadow p-4 mb-8">
        <h2 class="text-lg font-semibold mb-4">Configuración de IA</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600">Modelo por defecto</label>
            <select id="settings-model" class="w-full mt-1 border rounded px-3 py-2"></select>
          </div>
          <div class="md:col-span-2">
            <div id="model-costs" class="text-sm text-gray-700 bg-gray-50 border rounded px-3 py-2"></div>
          </div>
          <div>
            <label class="text-sm text-gray-600">Temperatura</label>
            <input id="settings-temp" type="number" step="0.1" min="0" max="2" class="w-full mt-1 border rounded px-3 py-2" placeholder="0.7">
          </div>
          <div>
            <label class="text-sm text-gray-600">Max tokens por respuesta</label>
            <input id="settings-max" type="number" min="1" max="4000" class="w-full mt-1 border rounded px-3 py-2" placeholder="1000">
          </div>
          <div id="gpt5-effort-field" class="hidden">
            <label class="text-sm text-gray-600">GPT‑5: Reasoning effort</label>
            <select id="settings-gpt5-effort" class="w-full mt-1 border rounded px-3 py-2">
              <option value="">(auto)</option>
              <option value="low">low</option>
              <option value="medium">medium</option>
              <option value="high">high</option>
            </select>
          </div>
          <div id="gpt5-verbosity-field" class="hidden">
            <label class="text-sm text-gray-600">GPT‑5: Verbosity</label>
            <select id="settings-gpt5-verbosity" class="w-full mt-1 border rounded px-3 py-2">
              <option value="">(auto)</option>
              <option value="brief">brief</option>
              <option value="balanced">balanced</option>
              <option value="verbose">verbose</option>
            </select>
          </div>
          <div id="gpt5-note" class="md:col-span-2 hidden text-sm text-blue-700 bg-blue-50 border border-blue-200 rounded px-3 py-2">
            Estos controles solo aplican a modelos <b>GPT‑5</b>. Selecciona un modelo GPT‑5 para habilitarlos.
          </div>
          <div class="md:col-span-2">
            <label class="text-sm text-gray-600">System prompt</label>
            <textarea id="settings-prompt" rows="4" class="w-full mt-1 border rounded px-3 py-2" placeholder="Eres un asistente útil, tu nombre es mirlo"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end">
            <button id="save-settings" class="bg-indigo-600 text-white px-4 py-2 rounded">Guardar configuración</button>
          </div>
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold">Últimos consumos</h2>
          <button id="regen" class="text-sm bg-indigo-600 text-white px-3 py-1 rounded">Regenerar API key</button>
        </div>
        <div class="bg-white shadow rounded overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="text-left p-2">Fecha</th>
                <th class="text-left p-2">Modelo</th>
                <th class="text-right p-2">Tokens In</th>
                <th class="text-right p-2">Tokens Out</th>
                <th class="text-right p-2">Costo (USD)</th>
              </tr>
            </thead>
            <tbody id="logs"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      function fmt(n){ return new Intl.NumberFormat('es-AR', { maximumFractionDigits: 6 }).format(n) }
      async function get(path){ const r = await fetch(path); if(!r.ok) throw new Error(await r.text()); return r.json(); }
      async function post(path, data){ const r = await fetch(path, {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(data||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

      async function loadSettings(){
        try{
          const r = await fetch('/api/settings');
          if(!r.ok) throw new Error(await r.text());
          const { settings } = await r.json();
          // cargar modelos
          try {
            const rm = await fetch('/api/models');
            const { models } = await rm.json();
            window.__models = models;
            const sel = document.getElementById('settings-model');
            sel.innerHTML = '';
            for (const m of models) {
              const opt = document.createElement('option');
              opt.value = m.name;
              opt.textContent = `${m.name} (${m.provider})`;
              sel.appendChild(opt);
            }
            sel.addEventListener('change', renderCosts);
          } catch (e) { console.error(e); }

          document.getElementById('settings-model').value = settings?.modelDefault ?? 'gpt-4.1-mini';
          document.getElementById('settings-temp').value = settings?.temperature ?? 0.7;
          document.getElementById('settings-max').value = settings?.maxTokens ?? 1000;
          document.getElementById('settings-prompt').value = settings?.systemPrompt ?? 'Eres un asistente útil, tu nombre es mirlo';
          // GPT-5 knobs
          const eff = document.getElementById('settings-gpt5-effort');
          const verb = document.getElementById('settings-gpt5-verbosity');
          if (eff) eff.value = settings?.gpt5ReasoningEffort || '';
          if (verb) verb.value = settings?.gpt5Verbosity || '';
          renderCosts();
          toggleGpt5Fields();
        }catch(e){ console.error(e); }
      }

      function renderCosts(){
        try{
          const sel = document.getElementById('settings-model');
          const name = sel.value;
          const models = window.__models || [];
          const m = models.find(x => x.name === name);
          const div = document.getElementById('model-costs');
          if(!m){ div.textContent = ''; return; }
          const inC = Number(m.inputCostPerMillion);
          const outC = Number(m.outputCostPerMillion);
          div.innerHTML = `
            <div><b>Proveedor:</b> ${m.provider}</div>
            <div><b>Costo input:</b> $ ${inC} / 1M tokens</div>
            <div><b>Costo output:</b> $ ${outC} / 1M tokens</div>`;
        }catch(e){ console.error(e); }
      }

      function toggleGpt5Fields(){
        const sel = document.getElementById('settings-model');
        const isGpt5 = (sel.value || '').toLowerCase().startsWith('gpt-5');
        const f1 = document.getElementById('gpt5-effort-field');
        const f2 = document.getElementById('gpt5-verbosity-field');
        const note = document.getElementById('gpt5-note');
        if (f1) f1.classList.toggle('hidden', !isGpt5);
        if (f2) f2.classList.toggle('hidden', !isGpt5);
        if (note) note.classList.toggle('hidden', isGpt5);
      }

      async function saveSettings(){
        const body = {
          modelDefault: (document.getElementById('settings-model')).value.trim(),
          temperature: Number((document.getElementById('settings-temp')).value),
          maxTokens: Number((document.getElementById('settings-max')).value),
          systemPrompt: (document.getElementById('settings-prompt')).value
        };
        // Adjuntar GPT-5 knobs si fueron configurados
        const eff = (document.getElementById('settings-gpt5-effort'))?.value;
        const verb = (document.getElementById('settings-gpt5-verbosity'))?.value;
        if (eff) body.gpt5ReasoningEffort = eff;
        if (verb) body.gpt5Verbosity = verb;
        const r = await fetch('/api/settings', { method: 'POST', headers: { 'content-type':'application/json' }, body: JSON.stringify(body) });
        if(!r.ok){ alert('Error guardando: ' + await r.text()); return; }
        alert('Configuración guardada');
      }

      async function load() {
        try {
          const me = await get('/api/me');
          const usage = await get('/api/usage');

          document.getElementById('info').innerHTML = `
            <div class="bg-white p-4 rounded shadow">
              <div class="text-sm text-gray-500">Tenant</div>
              <div class="text-lg font-semibold">${me.tenant.name}</div>
            </div>
            <div class="bg-white p-4 rounded shadow">
              <div class="text-sm text-gray-500">Balance</div>
              <div class="text-lg font-semibold">$ ${fmt(me.tenant.balance)}</div>
            </div>
            <div class="bg-white p-4 rounded shadow">
              <div class="text-sm text-gray-500">API Key</div>
              <div class="text-xs break-all">${me.tenant.apikey}</div>
            </div>`;

          await loadSettings();

          const tbody = document.getElementById('logs');
          tbody.innerHTML = '';
          for (const log of usage.logs) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="p-2">${new Date(log.createdAt).toLocaleString()}</td>
              <td class="p-2">${log.modelId}</td>
              <td class="p-2 text-right">${fmt(log.tokensIn)}</td>
              <td class="p-2 text-right">${fmt(log.tokensOut)}</td>
              <td class="p-2 text-right">$ ${fmt(log.costUsd)}</td>`;
            tbody.appendChild(tr);
          }
        } catch (e) {
          location.href = '/';
        }
      }

      document.getElementById('logout').addEventListener('click', async () => {
        await post('/auth/logout');
        location.href = '/';
      });

      document.getElementById('regen').addEventListener('click', async () => {
        try { const r = await post('/api/regenerate-key'); alert('Nueva API key: ' + r.apikey); load(); } catch(e){ alert('Error: '+e) }
      });

      document.getElementById('save-settings').addEventListener('click', saveSettings);
      document.getElementById('settings-model').addEventListener('change', toggleGpt5Fields);

      load();
    </script>
  </body>
  </html>


